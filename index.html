<!-- /index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takibi</title>

  <!-- Flatpickr (yalnÄ±zca iOS/uyumsuz tarayÄ±cÄ±da etkinleÅŸtirilecek) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

  <style>
.wide-popup {
  width: 500px !important;
  max-width: 90vw !important;
}
/* Select kutusunu ortala */
.centered-select {
  display: block !important;
  margin: 0 auto !important;
  width: 90% !important;
  max-width: 400px;
  font-size: 16px;
  padding: 10px;
  box-sizing: border-box;
}
input[type="date"],
select,
textarea {
  width: 100%;
  box-sizing: border-box;
}
@media print {
  body * { visibility: hidden; }
  .print-area, .print-area * { visibility: visible; }
  .print-area {
    position: absolute;
    left: 0; top: 0; width: 100%;
  }
  .no-print { display: none !important; }
  @page { size: A4 portrait; margin: 1cm; }
}
@media print { body * { visibility: hidden; } .print-area, .print-area * { visibility: visible; } .print-area { position: absolute; left: 0; top: 0; } }

body{
  font-family: Arial, sans-serif;
  background:#fffaf5; color:#333; margin:0; padding:0;
}
.container{
  max-width:700px; margin:auto; padding:20px; background:#fff;
  border-radius:20px; box-shadow:0 0 10px rgba(0,0,0,0.1);
}
h1{ text-align:center; color:#e65c00; font-size:26px; margin-bottom:20px; }
label{ display:block; margin:10px 0 5px; font-weight:bold; }
input[type="date"], textarea, select{
  width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; margin-bottom:10px;
}
.student-grid{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap:10px; margin-bottom:20px; max-height:400px; overflow-y:auto;
}
.student-card{
  display:flex; flex-direction:column; background:#fff5eb; padding:10px; border-radius:15px;
  border-left:5px solid #ffa94d; gap:8px; border:1px solid #ffa94d;
  box-shadow:0 2px 5px rgba(0,0,0,0.05); transition:transform .2s ease, box-shadow .2s ease; cursor:pointer;
}
.student-card:hover{ transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.student-name{ font-size:16px; font-weight:bold; word-break:break-word; color:#333; transition:color .3s ease; }
.student-card:hover .student-name{ color:#e65c00; }
.student-status{ width:35%; }
button{
  width:100%; padding:12px; background-color:#f5790f; border:none; color:#fff; font-size:18px; border-radius:10px; cursor:pointer;
}
@media print{
  body *{ visibility:hidden; }
  #print-area, #print-area *{ visibility:visible; }
  #print-area{
    position:absolute; top:0; left:0; width:100%; padding:20px;
  }
  .print-section{ page-break-after:always; }
}
table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px;}
th,td{ border:1px solid #555; padding:6px; text-align:left; }
th{ background:#ffe0cc; color:#333; }
.section-title{ color:#e65c00; font-size:20px; margin:10px 0; }

.whatsapp-btn{
  background-color:#25D366; border:none; color:#fff; border-radius:8px; padding:4px 4px; font-size:12px; cursor:pointer; margin-left:10px; transition:all .3s ease;
}
.whatsapp-btn:hover{ background-color:#1ebe5b; box-shadow:0 2px 6px rgba(0,0,0,0.2); transform:scale(1.05); }

.student-status-row{ justify-content:space-between; align-items:center; display:flex; gap:6px;}
.student-status-row select{ flex-grow:1; }
.student-status-row .whatsapp-btn{ flex-shrink:0; white-space:nowrap; }
.student-status-row select{ flex:1.3; padding:10px; font-size:16px; border-radius:8px;}
.student-status-row .whatsapp-btn{ flex:0.6; font-size:18px; padding:10px 14px; height:100%; display:flex; justify-content:center; align-items:center;}
.student-status-row .whatsapp-btn{ flex:0.5; font-size:14px; padding:6px 8px; height:auto; display:flex; justify-content:center; align-items:center; }

.action-buttons{
  display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:20px; padding:0 10px;
}
.action-buttons button{
  background-color:#ffa94d; color:#fff; font-size:14px; padding:10px; border:none; border-radius:8px; cursor:pointer;
  display:flex; justify-content:center; align-items:center; gap:6px; transition:background-color .3s ease;
}
.action-buttons button:hover{ background-color:#f5790f; }
  </style>
</head>
<body>
  <div class="container">
    <input type="hidden" id="currentFormKey" />
    <h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼<br/>Ã–dev Takibi</h1>

    <label for="date">Tarih:</label>
    <!-- iOS uyumluluÄŸu iÃ§in pattern/placeholder; polyfill gerektiÄŸinde devreye giriyor -->
    <input id="date" type="date" inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}" placeholder="YYYY-MM-DD"/>

    <label for="teacherSelect">Ã–ÄŸretmen:</label>
    <select id="teacherSelect">
      <option value="">-- Ã–ÄŸretmen SeÃ§in --</option>
      <option value="fen">Ferhat Bey (Fen Bilimleri)</option>
      <option value="math_huseyin">HÃ¼seyin Bey (Matematik)</option>
      <option value="sosyal">GÃ¼lÃ§in HanÄ±m (Sosyal Bilgiler)</option>
      <option value="turkce">MÃ¼ÅŸerref HanÄ±m (TÃ¼rkÃ§e)</option>
      <option value="ingilizce">Sedef HanÄ±m (Ä°ngilizce)</option>
      <option value="math_busra">BÃ¼ÅŸra HanÄ±m (Matematik)</option>
      <!-- Geriye dÃ¶nÃ¼k: Eski kayÄ±tlarda "matematik" olabilir -->
      <option value="matematik" style="display:none;">(Eski) Matematik</option>
    </select>

    <!-- SÄ±nÄ±f + Ãœnite -->
    <div style="border-top: 2px dashed #ffa94d; margin: 15px 0; padding: 10px 0;">
      <label for="gradeLevel" style="font-weight:bold; color:#e65c00;">SÄ±nÄ±f DÃ¼zeyi:</label>
      <select id="gradeLevel" style="width:100%; padding:10px; margin-top:5px;">
        <option value="">-- SÄ±nÄ±f SeÃ§in --</option>
        <option value="8">8. SÄ±nÄ±f</option>
        <option value="7">7. SÄ±nÄ±f</option>
        <option value="6">6. SÄ±nÄ±f</option>
        <option value="5">5. SÄ±nÄ±f</option>
      </select>

      <label for="unitSelect" style="font-weight:bold; color:#e65c00;">Ãœnite SeÃ§imi:</label>
      <select id="unitSelect" style="width:100%; padding:10px; margin-top:5px;">
        <option value="">-- Ãœnite SeÃ§in --</option>
      </select>
    </div>

    <label for="homework">Ã–dev:</label>
    <textarea id="homework" rows="2"></textarea>

    <label for="classSelect">SÄ±nÄ±f SeÃ§in:</label>
    <select id="classSelect">
      <option value="">-- SÄ±nÄ±f SeÃ§in --</option>
      <option value="8A">8A</option>
      <option value="8B">8B</option>
      <option value="8C">8C</option>
    </select>

    <div id="students" class="student-grid"></div>

    <div class="action-buttons">
      <button onclick="printReport()"><span>ğŸ–¨ï¸</span> YazdÄ±r</button>
      <button onclick="saveFormToLocalStorage()"><span>ğŸ’¾</span> Kaydet</button>
      <button onclick="loadFormFromLocalStorage()"><span>ğŸ“‚</span> YÃ¼kle</button>
      <button onclick="clearLocalStorageForm()"><span>ğŸ—‘ï¸</span> Sil</button>
      <button onclick="updateFormInLocalStorage()">ğŸ” GÃ¼ncelle</button>
      <button onclick="refreshForm()">ğŸ”„ Yenile</button>
    </div>
  </div>

  <div id="print-area" style="display:none;"></div>

<script>
/* --------------------------
   GÃ¼venli localStorage sarmalayÄ±cÄ±larÄ± (iOS Gizli Mod uyumu)
   -------------------------- */
// Neden: Safari Gizli Mod'da localStorage eriÅŸimi hata verebilir.
const safeStorage = (() => {
  try {
    const testKey = "__fck_test__";
    window.localStorage.setItem(testKey, "1");
    window.localStorage.removeItem(testKey);
    return {
      getItem: (k) => window.localStorage.getItem(k),
      setItem: (k, v) => window.localStorage.setItem(k, v),
      removeItem: (k) => window.localStorage.removeItem(k),
      keys: () => Object.keys(window.localStorage),
      available: true
    };
  } catch (e) {
    return {
      getItem: () => null,
      setItem: () => {},
      removeItem: () => {},
      keys: () => [],
      available: false
    };
  }
})();

/* --------------------------
   Veriler
   -------------------------- */
const studentData = {
  '8A': ["ENSAR AYGÃœN","MAHMUT EGE AYHAN","KAYRA BAÅAR","Ä°PEK BÃœBER","ELBÄ°M HÄ°KMET DEMÄ°REL","NÄ°DA CEYLÄ°N DOÄAN","CENGÄ°Z TUNÃ‡ IÅIK","ALÄ° KAAN KALE","DENÄ°Z KARAÃ‡AYIR","ASYA KAZAK","MÃœJDAT KÄ°LÄ°MCÄ°","BERRÄ°N PAMUKÃ‡U","ASYA TUNÃ‡","NEVA TUNÃ‡","EYMEN VURAL","TOPRAK YILMAZ","YAÄIZ DOÄAÃ‡ Ã–ZKAYNAK","ALÄ° NEZÄ°H Ã–ZTÃœRK","GÃœNEY Ã–ZYURTERÄ°","BUÄLEM CESUR"],
  '8B': ["AYBERK AKGÃœL","NECDET AHMET ALAÅAN","ONURAY ALBAN","AHMET GÃ–KMEN","ESMA GÃ–KTEPE","ALMÄ°LA GÃœRÃ‡Ä°Ã‡EK","EFE KALELÄ°","BEREN KURT","EMÄ°R CÄ°HAN KURT","YÃœSRA KÃœÃ‡ÃœKSOKU","KUZEY EROL MUTLU","GÃœLSÄ°MA OYAMAK","SALÄ°HA BUSE TÃœMTÃœRK","EREN ALP YAÄLI","Ã–ZÃœM YILMAZ","EZGÄ° ZORBAÅ","ECRÄ°N Ã–ÄMEN"],
  '8C': ["YAÄMUR GÃœLEN ALA","SELEN ATABEY","BETÃœL Ä°LKÄ°M AYDIN","KAAN GÃ–KTEPE","SERENAY GÃ–NEN","FURKAN AHMET GÃ–NENÃ‡","ADA HELVACIOÄLU","DAMLA HELVACIOÄLU","EGEMEN IÅIK","AHMET ALÄ° TUNA","EGEHAN YALINIZ","DÄ°LARA ELA YENÄ°GÃœL","REYHAN YILDIRIM","Ä°LKÄ°N ECRÄ°N YILDIRIM"]
};

// Not: Anahtarlar benzersiz. Eski "matematik" iÃ§in geriye dÃ¶nÃ¼k destek var.
const teachers = {
  fen:          { name: "Ferhat Bey",  subject: "Fen Bilimleri", subjectKey: "fen" },
  math_huseyin: { name: "HÃ¼seyin Bey", subject: "Matematik",     subjectKey: "matematik" },
  sosyal:       { name: "GÃ¼lÃ§in HanÄ±m",subject: "Sosyal Bilgiler",subjectKey: "sosyal" },
  turkce:       { name: "MÃ¼ÅŸerref HanÄ±m",subject: "TÃ¼rkÃ§e",      subjectKey: "turkce" },
  ingilizce:    { name: "Sedef HanÄ±m", subject: "Ä°ngilizce",     subjectKey: "ingilizce" },
  math_busra:   { name: "BÃ¼ÅŸra HanÄ±m", subject: "Matematik",     subjectKey: "matematik" },
  // Geriye dÃ¶nÃ¼k (eski kayÄ±tlar iÃ§in): matematik -> varsayÄ±lan BÃ¼ÅŸra
  matematik:    { name: "Bilinmiyor",  subject: "Matematik",     subjectKey: "matematik" }
};

const allUnits = {
 turkce: {
    "5": ["SÃ¶zcÃ¼kte Anlam","CÃ¼mlede Anlam","Paragrafta Anlam","Dil Bilgisi","YazÄ±m KurallarÄ±","Noktalama Ä°ÅŸaretleri","Metin TÃ¼rleri","AnlatÄ±m BozukluklarÄ±"],
    "6": ["SÃ¶zcÃ¼kte Anlam","CÃ¼mlede Anlam","Paragraf Yorumu","Fiil, Zarf, SÄ±fat","YazÄ±m ve Noktalama","Paragraf Ã‡Ã¶zÃ¼mleme","Metin YapÄ±sÄ±","Deyim ve AtasÃ¶zleri"],
    "7": ["SÃ¶zcÃ¼kte Anlam","Paragraf Bilgisi","CÃ¼mlede Anlam","Dil Bilgisi","YazÄ±lÄ± AnlatÄ±m","Metin TÃ¼rleri","AnlatÄ±m BozukluklarÄ±"],
    "8": ["SÃ¶zcÃ¼kte ve CÃ¼mlede Anlam","Paragraf Bilgisi","Dil Bilgisi","Metin TÃ¼rleri","YazÄ±m ve Noktalama","AnlatÄ±m BozukluklarÄ±"]
  },
 matematik: {
    "5": ["DoÄŸal SayÄ±lar","Kesirler","OndalÄ±k SayÄ±lar","Geometri","Veri ve Ä°statistik","Zaman","Ã–rÃ¼ntÃ¼ler ve SÃ¼reÃ§ler"],
    "6": ["Tam SayÄ±lar","Kesirler ve OndalÄ±klar","Oran ve OrantÄ±","Cebirsel Ä°fadeler","Geometrik Cisimler","Veri ve OlasÄ±lÄ±k"],
    "7": ["Tam SayÄ±lar","Rasyonel SayÄ±lar","Denklemler","Oran ve OrantÄ±","Geometrik Cisimler","AÃ§Ä±lar ve Ã‡okgenler","Veri Yorumlama"],
    "8": ["Ã‡arpanlar ve Katlar","ÃœslÃ¼ SayÄ±lar","KarekÃ¶klÃ¼ Ä°fadeler","Denklemler","EÅŸitsizlikler","Geometrik Cisimler","OlasÄ±lÄ±k","EÅŸlik ve Benzerlik"]
  },
 fen: {
    "5": ["GÃ¼neÅŸ, DÃ¼nya ve Ay","Kuvvet ve Hareket","Maddeyi TanÄ±yalÄ±m","IÅŸÄ±k ve Ses","CanlÄ±lar DÃ¼nyasÄ±","Elektrik ve Enerji"],
    "6": ["Destek ve Hareket Sistemi","Sindirim â€“ DolaÅŸÄ±m â€“ Solunum","Kuvvet â€“ SÃ¼rat","YoÄŸunluk â€“ IsÄ± â€“ Hal DeÄŸiÅŸimi","Ses","Elektrik ve YaÅŸam"],
    "7": ["GÃ¼neÅŸ Sistemi","HÃ¼cre ve BÃ¶lÃ¼nmeler","Kuvvet â€“ Enerji","Madde ve KarÄ±ÅŸÄ±mlar","IÅŸÄ±k â€“ Ses","CanlÄ±larda Enerji","Elektrik Devreleri"],
    "8": ["Mevsimler ve Ä°klim","DNA ve Genetik Kod","BasÄ±nÃ§","Madde ve EndÃ¼stri","Basit Makineler","Enerji DÃ¶nÃ¼ÅŸÃ¼mleri","Elektrik YÃ¼kleri"]
  },
 sosyal: {
    "5": ["Birlikte YaÅŸama","KÃ¼ltÃ¼rel Miras","Ä°nsanlar, Yerler ve Ã‡evreler","Ãœretim, DaÄŸÄ±tÄ±m, TÃ¼ketim","Birey ve Toplum","Bilim, Teknoloji, Toplum"],
    "6": ["Zaman ve Mekan","KÃ¼ltÃ¼r ve Miras","Ä°nsanlar ve Yerler","Bilim â€“ Teknoloji â€“ Toplum","Ekonomi â€“ Kaynaklar","Demokrasi ve YurttaÅŸlÄ±k"],
    "7": ["KÃ¼ltÃ¼r ve Miras","Ä°nsanlar ve Yerler","Bilimsel GeliÅŸmeler","Ekonomi ve Kaynaklar","VatandaÅŸlÄ±k ve Haklar","KÃ¼resel BaÄŸlantÄ±lar"],
    "8": ["Ä°nkÄ±lap Tarihi","KurtuluÅŸ SavaÅŸÄ±","Cumhuriyet DÃ¶nemi","Demokrasi KÃ¼ltÃ¼rÃ¼","Toplum ve DeÄŸerler"]
  },
 ingilizce: {
    "5": ["Hello!","My Town","Games and Hobbies","Health","The Animal Shelter","My Daily Routine","My House","My Clothes"],
    "6": ["Life","Weather","Occupations","Downtown","Holidays","Environment","Bookworms","Democracy"],
    "7": ["Appearance","Sports","Biographies","Movies and Media","Environment","Celebrations","Dreams","Jobs and Future"],
    "8": ["Friendship","Teen Life","In the Kitchen","On the Phone","The Internet","Adventures","Tourism","Science"]
  },
 din: {
    "5": ["Ä°slam'Ä±n Temel Ä°nanÃ§larÄ±","Peygamberimiz ve Ailesi","Ä°badetler","Ahlak ve DeÄŸerler","Kuranâ€™dan Mesajlar"],
    "6": ["Allah Ä°nancÄ±","Peygamberler ve Dualar","Ä°badet Bilinci","Ä°slam AhlakÄ±","Toplumsal Sorumluluk"],
    "7": ["Ä°nanÃ§ ve Ä°badet","Peygamberimizin HayatÄ±","Kur'an ve MesajlarÄ±","Ahlak ve DavranÄ±ÅŸ","Din KÃ¼ltÃ¼rÃ¼"],
    "8": ["Ä°slamâ€™da Kader","Ä°slamâ€™da Sosyal Adalet","ZekÃ¢t ve Sadaka","Hz. Muhammedâ€™in Ã–rnekliÄŸi","Kur'anâ€™Ä±n Ã–zellikleri"]
  }
};

/* --------------------------
   Ã–ÄŸrenci kartlarÄ±nÄ±n yÃ¼klenmesi
   -------------------------- */
document.getElementById("classSelect").addEventListener("change", function () {
  const selectedClass = this.value;
  const container = document.getElementById("students");
  container.innerHTML = "";
  if (!studentData[selectedClass]) return;
  studentData[selectedClass].slice().sort().forEach(name => {
    const div = document.createElement("div");
    div.className = "student-card";
    div.innerHTML = `
      <span class="student-name" onclick="openStudentModal('${name}')">â–ª ${name}</span>
      <div class="student-status-row">
        <select class="student-status">
          <option value="yaptÄ±">âœ… YaptÄ±</option>
          <option value="yapmadÄ±">âŒ YapmadÄ±</option>
          <option value="eksik">â— Eksik</option>
          <option value="gelmedi">â›” Gelmedi</option>
        </select>
        <button class="whatsapp-btn" onclick="
          const card = this.closest('.student-card');
          const studentName = card.querySelector('.student-name').innerText.replace('â–ª ', '');
          const statusSelect = card.querySelector('.student-status');
          const statusText = statusSelect.options[statusSelect.selectedIndex].text;
          const icon = statusText.split(' ')[0];
          const label = statusText.split(' ').slice(1).join(' ');
          generateWhatsappLink(studentName, icon, label);
        ">ğŸ“©</button>
      </div>
    `;
    container.appendChild(div);
  });
});

/* --------------------------
   YazdÄ±rma (iOS uyumlu: iframe ile)
   -------------------------- */
function printReport() {
  const rawDate = document.getElementById("date").value;
  const grade = document.getElementById("gradeLevel").value;
  const unit = document.getElementById("unitSelect").value;
  const homework = document.getElementById("homework").value;
  const selectedClass = document.getElementById("classSelect").value;
  const teacherKey = document.getElementById("teacherSelect").value;
  const teacherInfo = teachers[teacherKey];
  const teacher = teacherInfo?.name || teacherKey;
  const students = document.querySelectorAll(".student-card");

  if (!rawDate || !grade || !unit || !homework || !selectedClass) {
    Swal.fire({ icon:'warning', title:'Eksik Alan!', text:'Tarih, sÄ±nÄ±f, Ã¼nite ve Ã¶dev bilgilerini doldurunuz.', confirmButtonText:'Tamam' });
    return;
  }
  if (!teacher) {
    Swal.fire({ icon:'warning', title:'Ã–ÄŸretmen SeÃ§ilmedi', text:'LÃ¼tfen Ã¶ÄŸretmen seÃ§iniz.', confirmButtonText:'Tamam' });
    return;
  }
  if (students.length === 0) {
    Swal.fire({ icon:'error', title:'Ã–ÄŸrenci BulunamadÄ±', text:'SeÃ§ilen sÄ±nÄ±fa ait Ã¶ÄŸrenci bulunamadÄ±.', confirmButtonText:'Tamam' });
    return;
  }

  const dateParts = rawDate.split("-");
  const dateFormatted = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;

  let yapanlar = "";
  let yapmayanlar = "";
  students.forEach(card => {
    const name = card.querySelector(".student-name").innerText.replace("â–ª ", "");
    const status = card.querySelector(".student-status").value;
    const label = card.querySelector(".student-status").selectedOptions[0].text;
    const row = `<tr><td>${name}</td><td>${label}</td></tr>`;
    if (status === "yaptÄ±") yapanlar += row; else yapmayanlar += row;
  });

  const printContent = `
  <!DOCTYPE html>
  <html><head>
    <meta charset="utf-8" />
    <title>Ã–dev Raporu - ${dateFormatted} - ${selectedClass} - ${unit}</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h1 { color: #e65c00; text-align: center; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
      th, td { border: 1px solid #555; padding: 6px; text-align: left; }
      th { background: #ffe0cc; }
      .section-title { font-size: 18px; color: #e65c00; margin-top: 20px; }
      .page-break { page-break-before: always; }
    </style>
  </head>
  <body>
    <h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takibi</h1>
    <p><strong>Ã–ÄŸretmen:</strong> ${teacher}</p>
    <p><strong>SÄ±nÄ±fÄ±:</strong> ${selectedClass}</p>
    <p><strong>Ãœnite:</strong> ${unit}</p>
    <p><strong>Ã–dev:</strong> ${homework}<span style="float:right; font-weight:bold; text-decoration:underline; color:#000;">${dateFormatted}</span></p>

    <h2 class="section-title">âœ… Ã–devi Yapanlar</h2>
    <table>
      <tr><th>Ã–ÄŸrenci AdÄ±</th><th>Durumu</th></tr>
      ${yapanlar}
    </table>

    <div class="page-break"></div>

    <h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takibi</h1>
    <p><strong>Ã–ÄŸretmen:</strong> ${teacher}</p>
    <p><strong>SÄ±nÄ±fÄ±:</strong> ${selectedClass}</p>
    <p><strong>Ãœnite:</strong> ${unit}</p>
    <p><strong>Ã–dev:</strong> ${homework}<span style="float:right; font-weight:bold; text-decoration:underline; color:#000;">${dateFormatted}</span></p>

    <h2 class="section-title">âŒ Yapmayan / Eksik / Gelmeyen</h2>
    <table>
      <tr><th>Ã–ÄŸrenci AdÄ±</th><th>Durumu</th></tr>
      ${yapmayanlar}
    </table>
  </body></html>`;

  // iOS uyumlu yazdÄ±rma: gÃ¶rÃ¼nmez iframe
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.right = '0';
  iframe.style.bottom = '0';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = '0';
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow || iframe.contentDocument;
  const idoc = doc.document || doc;
  idoc.open();
  idoc.write(printContent);
  idoc.close();

  // Neden: iOS'ta iÃ§erik render edilmeden print Ã§aÄŸrÄ±lÄ±rsa boÅŸ Ã§Ä±kar.
  iframe.onload = () => {
    try { (iframe.contentWindow || iframe).focus(); } catch(e){}
    try { (iframe.contentWindow || iframe).print(); } catch(e){}
    setTimeout(() => { document.body.removeChild(iframe); }, 1000);
  };
}

/* --------------------------
   WhatsApp mesajÄ±
   -------------------------- */
function generateWhatsappLink(name, statusIcon, statusLabel) {
  const rawDate = document.getElementById("date").value;
  const unit = document.getElementById("unitSelect").value;
  const homework = document.getElementById("homework").value;

  const teacherKey = document.getElementById("teacherSelect").value;
  const teacherInfo = teachers[teacherKey];
  const subject = teacherInfo?.subject || unit;
  const teacherName = teacherInfo?.name || "Ã–ÄŸretmen";

  if (!rawDate) {
    Swal.fire({ icon:'warning', title:'Tarih Eksik!', text:'LÃ¼tfen tarih giriniz.', confirmButtonText:'Tamam' });
    return;
  }

  const dateParts = rawDate.split("-");
  const formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;

  const message =
`ğŸ“¢ *Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Bilgilendirme*

SayÄ±n Velim,

ğŸ“ Ã–ÄŸrenci: *${name}*  
ğŸ‘©â€ğŸ« Ã–ÄŸretmen: *${teacherName} (${subject})*  
ğŸ“… Tarih: *${formattedDate}*  
ğŸ“š Konu: *${unit}*  
ğŸ“ Ã–dev: *${homework}*  
ğŸ“ Durum: ${statusIcon} *${statusLabel}*

SaygÄ±larÄ±mÄ±zla,  
*Fenomen Ã‡ocuk KulÃ¼bÃ¼*`;

  const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
  // Neden: iOS popup engeli; onclick iÃ§inde senkron aÃ§Ä±lÄ±r.
  window.open(url, '_blank');
}

/* --------------------------
   Ãœnite seÃ§eneklerini gÃ¼ncelle (subject bazlÄ±)
   -------------------------- */
function updateUnitOptions() {
  const grade = document.getElementById("gradeLevel").value;
  const teacherKey = document.getElementById("teacherSelect").value;
  const subjectKey = teachers[teacherKey]?.subjectKey || teacherKey; // geriye dÃ¶nÃ¼k
  const unitSelect = document.getElementById("unitSelect");

  unitSelect.innerHTML = '<option value="">-- Ãœnite SeÃ§in --</option>';

  if (grade && subjectKey && allUnits[subjectKey] && allUnits[subjectKey][grade]) {
    allUnits[subjectKey][grade].forEach(unit => {
      const opt = document.createElement("option");
      opt.value = unit;
      opt.textContent = unit;
      unitSelect.appendChild(opt);
    });
  }
}

/* --------------------------
   Olay dinleyicileri
   -------------------------- */
document.getElementById("gradeLevel").addEventListener("change", updateUnitOptions);
document.getElementById("teacherSelect").addEventListener("change", updateUnitOptions);

function safeAlertIfStorageBlocked() {
  if (!safeStorage.available) {
    Swal.fire({
      icon: 'warning',
      title: 'Depolama KullanÄ±lamÄ±yor',
      text: 'TarayÄ±cÄ±nÄ±zÄ±n gizli modu veya ayarlarÄ± nedeniyle kayÄ±t iÅŸlemleri devre dÄ±ÅŸÄ±. KayÄ±t/yÃ¼kleme/silme Ã§alÄ±ÅŸmayabilir.',
      confirmButtonText: 'Tamam'
    });
  }
}

/* --------------------------
   Kaydet / YÃ¼kle / Sil / GÃ¼ncelle
   -------------------------- */
function saveFormToLocalStorage() {
  safeAlertIfStorageBlocked();
  generateDateKey();

  if (!currentDateKey) {
    Swal.fire("Hata", "Anahtar oluÅŸturulamadÄ±. TÃ¼m alanlarÄ±n dolu olduÄŸundan emin olun.", "error");
    return;
  }

  const formData = {
    date: document.getElementById("date").value,
    class: document.getElementById("classSelect").value,
    grade: document.getElementById("gradeLevel").value,
    unit: document.getElementById("unitSelect").value,
    teacher: document.getElementById("teacherSelect").value,
    homework: document.getElementById("homework").value.trim(),
    students: Array.from(document.querySelectorAll(".student-card")).map(card => ({
      name: card.querySelector(".student-name").innerText.replace("â–ª ", ""),
      status: card.querySelector(".student-status").value
    }))
  };

  safeStorage.setItem(currentDateKey, JSON.stringify(formData));
  Swal.fire("Kaydedildi", `"${currentDateKey}" baÅŸarÄ±yla kaydedildi.`, "success");
}

let currentFormKey = null; // YÃ¼klenen kayÄ±t anahtarÄ±
let currentDateKey = "";   // Åu anki formdan oluÅŸturulan anahtar

function loadFormFromLocalStorage() {
  safeAlertIfStorageBlocked();
  const keys = safeStorage.keys().filter(key => key.includes(" - "));
  if (keys.length === 0) {
    Swal.fire({ icon:'info', title:"KayÄ±t BulunamadÄ±", text:"KayÄ±tlÄ± hiÃ§bir form yok.", confirmButtonText:"Tamam", customClass:{ popup:'wide-popup' } });
    return;
  }

  Swal.fire({
    title: "YÃ¼klenecek kayÄ±t seÃ§in",
    input: "select",
    inputOptions: keys.reduce((obj, key) => (obj[key]=key, obj), {}),
    inputPlaceholder: "KayÄ±t seÃ§in",
    showCancelButton: true,
    confirmButtonText: "YÃ¼kle",
    cancelButtonText: "Ä°ptal",
    customClass: { popup:'wide-popup', input:'centered-select' }
  }).then(result => {
    if (!result.isConfirmed) return;

    const selectedKey = result.value;
    currentFormKey = selectedKey;

    const formData = JSON.parse(safeStorage.getItem(selectedKey) || "{}");

    document.getElementById("date").value = formData.date || "";
    document.getElementById("classSelect").value = formData.class || "";
    document.getElementById("gradeLevel").value = formData.grade || "";

    // Geriye dÃ¶nÃ¼k: eski "matematik" anahtarÄ±nÄ± sakince dÃ¶nÃ¼ÅŸtÃ¼r
    const teacherValue = (formData.teacher === "matematik") ? "math_busra" : (formData.teacher || "");
    document.getElementById("teacherSelect").value = teacherValue;

    document.getElementById("homework").value = formData.homework || "";

    updateUnitOptions();

    setTimeout(() => {
      document.getElementById("unitSelect").value = formData.unit || "";
    }, 50);

    document.getElementById("classSelect").dispatchEvent(new Event("change"));

    setTimeout(() => {
      const cards = document.querySelectorAll(".student-card");
      (formData.students || []).forEach((savedStudent, index) => {
        const card = cards[index];
        if (card) card.querySelector(".student-status").value = savedStudent.status;
      });
    }, 100);
  });
}

function clearLocalStorageForm() {
  safeAlertIfStorageBlocked();
  const keys = safeStorage.keys().filter(key => key.includes(" - "));

  if (keys.length === 0) {
    Swal.fire({ icon:'info', title:"KayÄ±t Yok", text:"Silinecek kayÄ±t bulunamadÄ±.", confirmButtonText:"Tamam", customClass:{ popup:'wide-popup' } });
    return;
  }

  Swal.fire({
    title: "Silinecek kaydÄ± seÃ§in",
    input: "select",
    inputOptions: keys.reduce((obj, key) => (obj[key]=key, obj), {}),
    inputPlaceholder: "Silinecek kayÄ±t seÃ§in",
    showCancelButton: true,
    confirmButtonText: "Sil",
    cancelButtonText: "Ä°ptal",
    showDenyButton: true,
    denyButtonText: "ğŸ§¨ Toplu Sil",
    customClass: { popup:'wide-popup', input:'centered-select' }
  }).then(result => {
    if (result.isConfirmed) {
      const selectedKey = result.value;
      safeStorage.removeItem(selectedKey);
      Swal.fire({ icon:'success', title:"Silindi", text:`"${selectedKey}" kaydÄ± silindi.`, customClass:{ popup:'wide-popup' } });
    } else if (result.isDenied) {
      Swal.fire({ icon:'warning', title:'Emin misiniz?', text:'Bu iÅŸlem tÃ¼m kayÄ±tlarÄ± kalÄ±cÄ± olarak silecek!', showCancelButton:true, confirmButtonText:'Evet, Sil', cancelButtonText:'VazgeÃ§' })
      .then(confirmResult => {
        if (confirmResult.isConfirmed) {
          keys.forEach(key => safeStorage.removeItem(key));
          Swal.fire({ icon:'success', title:"TÃ¼m KayÄ±tlar Silindi", text:"TÃ¼m Ã¶dev formlarÄ± baÅŸarÄ±yla silindi.", customClass:{ popup:'wide-popup' } });
        }
      });
    }
  });
}

function updateFormInLocalStorage() {
  safeAlertIfStorageBlocked();
  if (!currentFormKey) {
    Swal.fire("GÃ¼ncelleme BaÅŸarÄ±sÄ±z", "LÃ¼tfen Ã¶nce bir kayÄ±t yÃ¼kleyin.", "error");
    return;
  }

  generateDateKey();
  if (currentFormKey !== currentDateKey) {
    Swal.fire({ icon:"warning", title:"Dosya AdÄ± DeÄŸiÅŸtirildi", text:"Dosya adÄ± deÄŸiÅŸtirildiÄŸi iÃ§in gÃ¼ncelleme yapÄ±lmayacak.", confirmButtonText:"Tamam" });
    return;
  }

  Swal.fire({
    title:"GÃ¼ncellemek istediÄŸinize emin misiniz?",
    text:`"${currentFormKey}" Ã¼zerine yazÄ±lacak.`,
    icon:"question",
    showCancelButton:true,
    confirmButtonText:"Evet, GÃ¼ncelle",
    cancelButtonText:"VazgeÃ§"
  }).then(result => {
    if (!result.isConfirmed) return;

    const formData = {
      date: document.getElementById("date").value,
      class: document.getElementById("classSelect").value,
      grade: document.getElementById("gradeLevel").value,
      unit: document.getElementById("unitSelect").value,
      teacher: document.getElementById("teacherSelect").value,
      homework: document.getElementById("homework").value.trim(),
      students: Array.from(document.querySelectorAll(".student-card")).map(card => ({
        name: card.querySelector(".student-name").innerText.replace("â–ª ", ""),
        status: card.querySelector(".student-status").value
      }))
    };

    safeStorage.setItem(currentFormKey, JSON.stringify(formData));
    Swal.fire("GÃ¼ncellendi", `"${currentFormKey}" baÅŸarÄ±yla gÃ¼ncellendi.`, "success");
  });
}

/* --------------------------
   Anahtar Ã¼retimi
   -------------------------- */
function generateDateKey() {
  const raw = document.getElementById("date").value || "";
  const date = raw.includes("T") ? raw.split("T")[0] : raw;
  const selectedClass = document.getElementById("classSelect").value || "";
  const homework = (document.getElementById("homework").value || "").trim();
  const teacherKey = document.getElementById("teacherSelect").value || "";
  const subject = teachers[teacherKey]?.subject || teacherKey;

  currentDateKey = `${subject} - ${date} - ${selectedClass} - ${homework}`;
}

/* --------------------------
   Ã–ÄŸrenci geÃ§miÅŸi (subject bazlÄ± eÅŸleÅŸtirme)
   -------------------------- */
function openStudentModal(studentName) {
  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

  const selectedTeacherKey = document.getElementById("teacherSelect").value;
  const currentSubject = teachers[selectedTeacherKey]?.subject || selectedTeacherKey;

  const relevantKeys = safeStorage.keys().filter(key => {
    const parts = key.split(" - ");
    const dateStr = parts.length >= 4 ? parts[1] : null;
    if (!dateStr) return false;
    const dateObj = new Date(dateStr);
    return !isNaN(dateObj.getTime()) && dateObj >= oneMonthAgo;
  });

  let studentReports = [];
  relevantKeys.forEach(key => {
    const dataRaw = safeStorage.getItem(key);
    if (!dataRaw) return;
    const data = JSON.parse(dataRaw);
    if (!data || !Array.isArray(data.students)) return;

    const match = data.students.find(s => s.name === studentName);
    if (!match) return;

    // Subject bazlÄ± eÅŸleÅŸtirme (eski "matematik" kaydÄ±yla uyum)
    const recSubject = teachers[data.teacher]?.subject || data.teacher || "-";
    if (recSubject !== currentSubject) return;

    const formattedDate = new Date(data.date).toLocaleDateString('tr-TR');
    const teacherName = teachers[data.teacher]?.name || data.teacher || "-";
    const subject = recSubject;

    studentReports.push({
      date: formattedDate,
      unit: data.unit,
      homework: data.homework,
      status: match.status,
      statusLabel: getStatusLabel(match.status),
      teacher: teacherName,
      subject: subject
    });
  });

  if (studentReports.length === 0) {
    Swal.fire({ icon:'info', title:'KayÄ±t BulunamadÄ±', text:`${studentName} iÃ§in son 1 ayda kayÄ±tlÄ± bir Ã¶dev verisi bulunamadÄ±.` });
    return;
  }

  const sample = studentReports[0];
  const msgHeader =
`ğŸ“¢ *Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takip Raporu*

SayÄ±n Velimiz,

ğŸ“ Ã–ÄŸrenciniz: *${studentName}*
ğŸ‘©â€ğŸ« Ã–ÄŸretmen: *${sample.teacher}*
ğŸ“Œ Ders: *${sample.subject}*
ğŸ—“ï¸ DÃ¶nem: *Son 1 Ay*

ğŸ“š *Ã–dev KatÄ±lÄ±m Listesi:*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`;

  const msgBody = studentReports.map(r =>
`ğŸ“… *${r.date}*
ğŸ“ Ã–dev: *${r.homework}*
ğŸ“˜ Ãœnite: *${r.unit}*
ğŸ“Œ Durum: ${r.statusLabel}
`).join('\n');

  const msgFooter =
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“¨ Geri bildirim ve detaylÄ± bilgi iÃ§in Ã¶ÄŸretmeninizle iletiÅŸime geÃ§ebilirsiniz.
SaygÄ±larÄ±mÄ±zla,
*Fenomen Ã‡ocuk KulÃ¼bÃ¼*`;

  const fullMessage = `${msgHeader}${msgBody}${msgFooter}`;

  Swal.fire({
    title: studentName,
    html: `<pre style="text-align:left;white-space:pre-wrap;font-size:13px;padding:10px 0">${fullMessage}</pre>`,
    showCancelButton: true,
    confirmButtonText: 'ğŸ“¤ GÃ¶nder',
    cancelButtonText: 'Kapat',
    customClass: { popup:'wide-popup' }
  }).then(result => {
    if (result.isConfirmed) {
      const whatsappURL = `https://wa.me/?text=${encodeURIComponent(fullMessage)}`;
      window.open(whatsappURL, '_blank');
    }
  });
}

function getStatusLabel(status) {
  switch (status) {
    case 'yaptÄ±': return 'âœ… YaptÄ±';
    case 'yapmadÄ±': return 'âŒ YapmadÄ±';
    case 'eksik': return 'â— Eksik';
    case 'gelmedi': return 'â›” Gelmedi';
    default: return 'â“ Bilinmiyor';
  }
}

function refreshForm() {
  document.getElementById("date").value = "";
  document.getElementById("teacherSelect").value = "";
  document.getElementById("gradeLevel").value = "";
  document.getElementById("unitSelect").innerHTML = '<option value="">-- Ãœnite SeÃ§in --</option>';
  document.getElementById("homework").value = "";
  document.getElementById("classSelect").value = "";
  document.getElementById("students").innerHTML = "";
}

/* --------------------------
   Tarih alanÄ±: iOS/uyumsuz tarayÄ±cÄ±lar iÃ§in Flatpickr
   -------------------------- */
// Neden: iOS eski Safari native date input saÄŸlamaz; yalnÄ±zca ihtiyaÃ§ halinde aÃ§.
function isIOS() {
  return /iP(hone|od|ad)/.test(navigator.platform) ||
         (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}
function isNativeDateSupported() {
  const i = document.createElement('input');
  i.setAttribute('type','date');
  const supported = (i.type === 'date') && ('valueAsDate' in i);
  return supported;
}
window.addEventListener('DOMContentLoaded', () => {
  // Dinleyiciler
  document.getElementById("date").addEventListener("change", generateDateKey);
  document.getElementById("classSelect").addEventListener("change", generateDateKey);
  document.getElementById("homework").addEventListener("input", generateDateKey);

  // Flatpickr yalnÄ±zca gerekli ise
  const needPolyfill = isIOS() || !isNativeDateSupported();
  if (needPolyfill && window.flatpickr) {
    flatpickr("#date", {
      dateFormat: "Y-m-d",
      allowInput: true,
      locale: window.flatpickr?.l10ns?.tr || 'tr'
    });
  }
});
</script>
</body>
</html>
